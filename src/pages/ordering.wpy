<style lang="less">
    .ordering {
        width: 100%;
        background: #f0f0f0;
        overflow: hidden;
        .title {
            text-align: center;
            line-height: 40rpx;
            font-size: 28rpx;
            padding: 25rpx 0;
            background: #ffffff;
        }
        //日期信息
        .date-info {
            margin-top: 20rpx;
            background: #ffffff;
            padding: 15rpx;
            display: flex;
            .info {
                font-size: 18rpx;
                color: #9c9c9c;
                text-align: center;
            }
            .date {
                font-size: 22rpx;
                color: #ff7e00;
                text-align: center;
                margin-top: 20rpx;
            }
            .start {
                flex: 3;
            }
            .date-length {
                flex: 1;
                .date-gray {
                    width: 50rpx;
                    height: 50rpx;
                    font-size: 18rpx;
                    text-align: center;
                    line-height: 60rpx;
                    margin: 15rpx auto;
                    background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAAY1BMVEVHcEzb29vb29vb29vb29vb29vb29vb29vb29vb29vc3Nzc3Nzc3Nzb29vb29vb29vb29vb29vc3Nzb29vb29vb29vb29vb29vc3Nzd3d3b29vb29vb29vc3Nza2trc3Nzb29tue/YUAAAAIHRSTlMAM0vMQImx8jyIAng3gpbG2vYn1OGm6lC1XUWsHLprDjX92MAAAADSSURBVEjH7ZXNFoIgEEbHUkFUUU38y5r3f8pIDpFaBa1acM9xMZ9cDjMLAHimIAPsaAWFtzCC/T6ssNhGWaCgZ3aSfwNdq7CWYQ61DjMGUDeoyaGUH67hMkxBPOqmBmNg8kppFqUyQQyI03hY6NTBDiu6AO4HCztVjhPOQDAF3RUTGMPn9lO5gmBkgoGH+zleeGaKaKt858+V1EVRE2tpaA1tF8WRH5U2o/aU7u1z9yEfveIVr3jFK9ZK4q44XuM9IPI8sUfgDL3rk5TCNSZOFOwGLD81FDyN4IYAAAAASUVORK5CYII=');
                    background-size: 50rpx 50rpx;
                }
            }
            .end {
                flex: 3;
            }
            .week {
                flex: 2;
            }
        }

        //选择信息
        .select-wrapper {
            margin-top: 20rpx;
            background: #ffffff;
            .select {
                padding: 10rpx 30rpx;
                border-bottom: 1px solid #e8e8e8;
                .s-title {
                    display: inline-block;
                    font-size: 24rpx;
                }
                .right {
                    float: right;
                    margin-top: 10rpx;
                    display: inline-block;
                    font-size: 24rpx;
                    text {
                        display: inline-block;
                        margin: 0 10rpx;
                        &.minus {
                            color: #9d9d9d;
                            font-size: 30rpx;
                        }
                        &.plus {
                            color: #ff7e00;
                            font-size: 30rpx;
                        }
                    }

                }
            }
        }

        //入住人信息
        .men {
            margin-top: 10rpx;
            background-color: #ffffff;
            .item {
                display: flex;
                font-size: 24rpx;
                padding: 0 30rpx;
                box-sizing: border-box;
                height: 60rpx;
                border-bottom: 1px solid #e8e8e8;
                .item-title {
                    flex: 2;
                    width: 210rpx;
                    min-width: 210rpx;
                    max-width: 210rpx;
                    line-height: 60rpx;
                }
                .item-input {
                    flex: 4;
                    input {
                        height: 60rpx;
                        line-height: 60rpx;
                    }
                }
                .item-icon {
                    flex: 2;
                    color: #ff7e00;
                    font-size: 20rpx;
                    line-height: 60rpx;
                    text-align: right;
                }
            }
        }

        //添加入住人
        .add {
            text-align: center;
            padding: 10rpx 0;
            .icon {
                display: inline-block;
                width: 40rpx;
                height: 40rpx;
                line-height: 35rpx;
                background: #ffffff;
                color: #ff7e00;
                font-size: 40rpx;
                border-radius: 40rpx;
                margin-right: 10rpx;
                text-align: center;
            }
            text {
                font-size: 22rpx;
            }
        }

        .price {
            background: #ffffff;
            padding: 20rpx 30rpx;
            .item {
                view {
                    display: inline-block;
                    vertical-align: middle;
                }
                .price-title {
                    font-size: 22rpx;
                    color: #727272;
                }
                .price-num {
                    font-size: 24rpx;
                }
                .nav {
                    font-size: 20rpx;
                    color: #ff7e00;
                    text-decoration: underline;
                    margin-left: 20rpx;
                }
                .high-num {
                    font-size: 22rpx;
                    color: #9a9a9a;
                    text-decoration: line-through;
                    float: right;
                    margin-top: 10rpx;
                }
                .total {
                    font-size: 22rpx;
                    color: #9a9a9a;
                    float: right;
                    margin-top: 10rpx;
                    text {
                        color: #ff7e00;
                    }
                }
            }
        }

        .info {
            padding: 0 30rpx;
            line-height: 40rpx;
            font-size: 20rpx;
            color: #717171;
        }

        .button {
            width: 220rpx;
            height: 60rpx;
            border-radius: 60rpx;
            background-color: #ff7e00;
            color: #ffffff;
            font-size: 26rpx;
            line-height: 60rpx;
            margin: 40rpx auto;
            text-align: center;
        }
    }
</style>
<template>
    <view class="ordering" style="min-height: {{height}}px;">
        <view class="title">
            <view>{{params.hotelName}}</view>
            <view>{{params.roomType}}</view>
        </view>
        <view class="date-info" @tap="showCalender">
            <view class="start">
                <view class="info">
                    入住时间
                </view>
                <view class="date">{{date[0]}}</view>
            </view>
            <view clas="week">
                <view class="info">
                    {{week[0]}}
                </view>
                <view class="date">{{time[0]}}</view>
            </view>
            <view class="date-length">
                <view class="date-gray">
                    {{datelen}}天
                </view>
            </view>
            <view clas="end">
                <view class="info">
                    离店时间
                </view>
                <view class="date">{{date[1]}}</view>
            </view>
            <view class="week">
                <view class="info">
                    {{week[1]}}
                </view>
                <view class="date">{{time[1]}}</view>
            </view>
            
        </view>
        <view class="select-wrapper">
             <view class="select">
                 <view class="s-title">请选择房间数量</view>
                 <view class="right">
                     <text class="minus" @tap="roomsDeal(0)">-</text>
                     <text class="inner">{{rooms}}间</text>
                     <text class="plus" @tap="roomsDeal(1)">+</text>
                 </view>
             </view>
             <view class="select">
                 <view class="s-title">请选择入住人数</view>
                 <view class="right">
                     <text class="minus" @tap="mensDeal(0)">-</text>
                     <text class="inner">{{mens}}人</text>
                     <text class="plus" @tap="mensDeal(1)">+</text>
                 </view>
             </view>
        </view>

        <repeat for="{{mens}}" key="index" index="index" item="item">
            <view class="men">
                <view class="item">
                    <view class="item-title">入住人</view>
                    <view class="item-input">
                        <input placeholder="请填写入住人" value="{{mensInfo[index].name}}" data-index="{{index}}" bindinput="inputmen"/>
                    </view>
                    <picker wx:if="{{resName.length > 0}}" @change="selectRes" data-index="{{index}}" value="{{resindex}}" range="{{resName}}">
                        <view class="item-icon">常用入住人</view>
                    </picker>
                    <view wx:if="{{resName.length == 0}}" @tap="noMens" class="item-icon">常用入住人</view>
                </view>
                <!-- <view class="item">
                    <view class="item-title">联系方式</view>
                    <view class="item-input">
                        <input placeholder="请填写联系方式"  type="number" />
                    </view>
                </view> -->

                <view class="item">
                    <view class="item-title">身份证号</view>
                    <view class="item-input">
                        <input placeholder="请填写身份证号" data-index="{{index}}" value="{{mensInfo[index].pid}}" type="idcard" bindinput="inputId"/>
                    </view>
                </view>
            </view>
        </repeat>

        <view class="add" @tap="mensDeal(1)">
            <view class="icon">+</view>
            <text>添加入住人</text>
        </view>

        <view class="price">
            <view class="item">
                <view class="price-title">房间总价:</view>
                <view class="price-num">￥{{showPrice.originalPrice}}</view>
                <view class="nav" @tap="gotoPrice">房费明细</view>
                <view class="high-num">订单总价: ¥{{showPrice.highPrice + showPrice.foregift}}</view>
            </view>

            <view class="item">
                <view class="price-title">住房押金:</view>
                <view class="price-num">￥{{showPrice.foregift}}</view>
                <view class="price-title total">订单总价: <text>￥{{showPrice.foregift + showPrice.originalPrice}}</text></view>

            </view>
        </view>


        <view class="info" style="margin-top: 30rpx;">
            订单取消以及退款规则:
        </view>
        <view class="info">
            1.成功支付订单后,房间将保留至次日12:00
        </view>
        <view class="info">
            2.如行程有变,请于当天14点前取消订单,否则将无法取消订单,已支付的房费将不予退还。
        </view>

        <view class="button" @tap="submit">
            提交订单
        </view>
        <ncalender wx:if="{{cshow}}"  @index-tap.user="calender" :type.sync="ctype" :outdate.sync="date"></ncalender>
    </view>
</template>
<script>

    import wepy from 'wepy'
    import Api from '../utils/api'
    import util from '../utils/util'
    import Calender from '../components/calender'

    const weekConfig = {
        0: '周日',
        1: '周一',
        2: '周二',
        3: '周三',
        4: '周四',
        5: '周五',
        6: '周六',
    }
    export default class Ordering extends wepy.page {
        config = {
            navigationBarTitleText: '房屋预定'
        }
        data = {
            height: 0,
            rooms: 1,
            mens: 1,
            params: {},
            date: [],
            datelen: 0,
            showPrice: {},
            priceInfo: {},
            mensInfo: [{
                name: '',
                pid: ''
            }],
            ctype: 1,
            cshow: false,
            time: [],
            week: [],
            resident: [],
            resName: [],
            resindex: 0
        }
        components = {
            ncalender: Calender
        }
        methods = {
            mensDeal (type) {
                if(type == 1) {
                    this.mens += 1
                }
                else {
                    if(this.mens > 1) {
                        this.mens -= 1
                    }
                    else {
                        wepy.showToast({
                            title: '入住人不能少于1人',
                            icon: 'none'
                        })
                    }

                }
                let num = this.mens
                console.log(this.mensInfo)
                this.mensInfo = this.methods.dealMens(num, this.mensInfo)
                this.$apply()
            },
            roomsDeal (type) {
                if(type == 1) {
                    this.rooms += 1
                }
                else {
                    if(this.rooms > 1) {
                        this.rooms -= 1
                    }
                    else {
                        wepy.showToast({
                            title: '房间不能少于1间',
                            icon: 'none'
                        })
                    }

                }
                
                this.showPrice = this.methods.dealShowPrice(this.rooms, this.priceInfo)
                
                this.$apply()
            },
            inputmen (e) {
                let value = e.detail.value
                let index = e.target.dataset.index
                this.mensInfo[index].name = value
                this.$apply()
            },
            inputId (e) {
                let value = e.detail.value
                let index = e.target.dataset.index
                this.mensInfo[index].pid = value
                this.$apply()
            },
            showCalender () {
                this.cshow = true
            },
            async calender (type, date) {
                this.cshow = false
                if (type) {
                    this.date = date
                    this.datelen = util.dateUtils.getDateDiff(date[0], date[1])
                    this.priceInfo = await this.methods.getPrice(date[0], date[1], this.datelen, this.params.roomId, this.userid)
                    this.showPrice = this.methods.dealShowPrice(this.rooms, this.priceInfo)
                    this.$apply()
                }

            },
            //获取常用入住人
            async getMens () {
                let userid = await wepy.getStorageSync('userid')
                let params = {
                    method: 'POST',
                    query: {
                        userid: userid
                    }
                }
                let resData = await Api.getMen(params)
                // console.log(resData)
                return resData.data.data
            },
            //选择常用入住人
            selectRes (e) {

                let index = e.detail.value
                let domIndex = e.target.dataset.index
                
                if(this.resident.length > 0) {
                    this.resindex = index
                    this.mensInfo[domIndex].name = this.resident[index].customerName
                    this.mensInfo[domIndex].pid = this.resident[index].customerIdentity
                    this.$apply()
                }
                else {
                    wepy.showToast({
                       title: '暂无常用入住人',
                       icon: 'none'
                    })
                }
                
            },
            async getPrice (bDate, eDate, len, roomid, userid) {
                let oType = wepy.getStorageSync('oType')
                let num = 0;
                if(oType == 'a') {
                    num = len
                }
                else {
                    let time = wepy.getStorageSync('time')
                    num = time
                }
                let params = {
                    method: 'POST',
                    data: {
                        bDate: bDate,
                        eDate: eDate || bDate,
                        lockNum: num,
                        type: oType
                    },
                    query: {
                        roomid: roomid,
                        userid: userid
                    }
                }
                let priceInfo = await Api.getPrice(params)

                return priceInfo.data.data
            },
            dealShowPrice (rooms, priceInfo) {
                let showPrice = {
                    originalPrice: 0,
                    foregift: priceInfo.foregift * rooms,
                    highPrice: priceInfo.originalPrice * rooms + priceInfo.foregift
                }

                let originPrice = 0
                priceInfo.roomBasePriceInfos.forEach((dayPrice) => {
                    originPrice += dayPrice.cmpnPrice * rooms
                })
                showPrice.originalPrice = originPrice
                return showPrice
            },
            dealMens (num, info) {
                let newData = []
                for (let i = 0; i < num; i ++) {
                    let data = {
                        name: '',
                        pid: ''
                    }
                    if(info[i] && info[i].name) {
                        data.name = info[i].name;
                        data.pid = info[i].pid
                    }
                    
                    newData.push(data)
                }
                return newData
            },
            async submit () {
                let data = this.params
                let name = wepy.getStorageSync('name')
                let oType = wepy.getStorageSync('oType')
                let phone = wepy.getStorageSync('phone')
                let userid = this.userid

                //校验身份证
                let isId = true;
                this.mensInfo.forEach((men) => {
                    let isCorrect = this.methods.isIdCardNo(men.pid)
                    if(!isCorrect) {
                       isId = isCorrect 
                    }
                })
                if(isId) {
                    data.roomCnt = this.rooms

                    data.bDate = this.date[0]
                    data.eDate = this.date[1]
                    data.lockTime = this.datelen
                    data.contactName = name
                    data.contactPhone = phone
                    data.personInfos = this.mensInfo
                    if(oType == 'a') {
                        data.bDate = this.date[0]
                        data.eDate = this.date[1]
                        data.lockTime = this.datelen
                        data.oType = 'a'
                    }
                    else {
                        let time = wepy.getStorageSync('time')
                        data.bDate = this.date[0]
                        data.eDate = this.date[0]
                        data.lockTime = time
                        data.oType = 'p'
                    }
                    let params = {
                        method: 'POST',
                        data: data,
                        query: {
                            userid: userid
                        }
                    }
                    let submitInfo = await Api.submitOrder(params)
                    
                    if(submitInfo.data.retCode == 0) {
                        wepy.redirectTo({
                            url: '../pages/afterOrder?orderid=' + submitInfo.data.data + '&reffer=' + '../pages/detail' 
                        })
                    }
                    else {
                       wepy.showToast({
                         title: submitInfo.data.retMsg,
                         icon: 'none'
                       }) 
                    }
                }
                else {
                    wepy.showToast({
                         title: '身份证号码输入有误',
                         icon: 'none'
                    }) 
                }
                
            },
            isIdCardNo(num) {
                num = num.toUpperCase()
                return /(^[1-9]\d{5}(18|19|([23]\d))\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$)|(^[1-9]\d{5}\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\d{3}$)/.test(num)
            },
            gotoPrice () {
                let param = {
                    hotelName: this.params.hotelName,
                    roomType: this.params.roomType,
                    priceInfo: this.priceInfo,
                    rooms: this.rooms
                }
                wepy.navigateTo({
                    url: '../pages/price?params=' + JSON.stringify(param)
                })
            },
            noMens () {
                wepy.showToast({
                  title: '没有常用入住人',
                  icon: 'none'
                }) 
            }
        }
        async onLoad (options) {
            let num = this.rooms * this.mens
            this.params = JSON.parse(options.params)
            let date =  await wepy.getStorageSync('date')
            this.userid = await wepy.getStorageSync('userid')
            
            //时租房 日租房
            let oType = wepy.getStorageSync('oType')
            let time = wepy.getStorageSync('time')
            if(oType == 'a') {
                this.time = ['12:00', '12:00']
                this.datelen = util.dateUtils.getDateDiff(date[0], date[1])
                this.date = date
            }
            else {
                let num = time + ':00'
                let num1 = time + 4 + ':00'
                this.time = [num, num1]
                this.datelen = 1
                this.date = [date[0], date[0]]
            }
            
            console.log(this.datelen)
            let week = [util.dateUtils.getWeekNum(date[0]).week, util.dateUtils.getWeekNum(date[1] || date[0]).week]
            console.log(week)
            this.week = [weekConfig[week[0]], weekConfig[week[1]]]
            this.$apply()
            this.priceInfo = await this.methods.getPrice(date[0], date[1], this.datelen, this.params.roomId, this.userid)
            this.showPrice = this.methods.dealShowPrice(this.rooms, this.priceInfo)
            this.mensInfo = this.methods.dealMens(num, this.mensInfo)
            let sysInfo = wepy.getSystemInfoSync()
            this.height = sysInfo.screenHeight
            
            //常用入住人
            this.resident = await this.methods.getMens()
            let resName = []
            this.resident.forEach((item) => {
                resName.push(item.customerName)
            })
            this.resName = resName
            
            this.$apply()
        }
    }
</script>
